<div class="calendar-container">
  <div class="top-controls">
    <div class="control-group">
      <app-view-mode-selector 
        [viewMode]="viewMode()" 
        (viewModeChange)="setViewMode($event)">
      </app-view-mode-selector>

      <div class="date-navigation">
        <button mat-icon-button (click)="viewMode() === 'daily' ? previousDay() : viewMode() === 'weekly' ? previousWeek() : previousMonth()" title="Previous">
          <mat-icon>chevron_left</mat-icon>
        </button>
        <span class="date-label">{{ navigationLabel() }}</span>
        <button mat-icon-button (click)="viewMode() === 'daily' ? nextDay() : viewMode() === 'weekly' ? nextWeek() : nextMonth()" title="Next">
          <mat-icon>chevron_right</mat-icon>
        </button>
        <button mat-icon-button (click)="goToToday()" title="Today">
          <mat-icon>today</mat-icon>
        </button>
      </div>

      <app-category-selector 
        [selectedCategory]="selectedCategory()" 
        [categories]="categories"
        (categoryChange)="selectCategory($event)">
      </app-category-selector>

      <app-add-task-button 
        (addTaskClick)="onAddTaskClick()">
      </app-add-task-button>
    </div>
  </div>

  <!-- ADD TASK FORM MODAL -->
  <div class="modal-overlay" *ngIf="showAddTaskForm()" (click)="onAddTaskClick()">
    <app-add-task-form 
      [categories]="categories"
      [selectedDate]="selectedDate()"
      (click)="$event.stopPropagation()"
      (taskSave)="onTaskAdded($event)"
      (taskCancel)="onAddTaskClick()">
    </app-add-task-form>
  </div>

  <!-- EDIT TASK FORM MODAL -->
  <div class="modal-overlay" *ngIf="showEditTaskForm() && editingTask()" (click)="onEditTaskCancel()">
    <app-edit-task-form 
      [task]="{
        id: editingTask()!.id!,
        title: editingTask()!.title,
        time: editingTask()!.time,
        category: editingTask()!.category || 'study'
      }"
      [categories]="categories"
      (click)="$event.stopPropagation()"
      (taskUpdate)="onTaskUpdated($event)"
      (taskDelete)="onTaskDeleted($event)"
      (taskCancel)="onEditTaskCancel()">
    </app-edit-task-form>
  </div>

  <div class="main-content">
    <!-- LEFT SIDE: NOTES -->
      <!-- This section can contain daily view notes if needed -->
    <!-- <div class="notes-sidebar">
     
    </div> -->

    <!-- SPIRAL DIVIDER -->
    <!-- <div class="spiral-divider"></div> -->

    <!-- CENTER: CALENDAR -->
    <div class="calendar-column" [class.monthly-view]="viewMode() === 'monthly'">
      <!-- EVENT DETAIL -->
      <app-event-detail
        *ngIf="selectedEvent()"
        [event]="selectedEvent()!"
        [categories]="categories"
        (eventUpdate)="onEventUpdate($event)"
        (eventDelete)="onEventDelete()"
        (eventClose)="onEventDetailClose()">
      </app-event-detail>

      <!-- CALENDAR VIEWS -->
      <app-calendar-daily *ngIf="viewMode() === 'daily'"
        [selectedDate]="selectedDate()"
        [events]="dailyEvents(selectedDate())"
        [categories]="categories"
        [startHour]="startHour"
        [endHour]="endHour"
        (eventClick)="onEventClick($event)">
      </app-calendar-daily>

      <app-calendar-weekly *ngIf="viewMode() === 'weekly'"
        [weekDays]="weekDays()"
        [events]="filteredEvents()"
        [categories]="categories"
        (eventClick)="onEventClick($event)">
      </app-calendar-weekly>

      <app-calendar-monthly *ngIf="viewMode() === 'monthly'"
        [calendarDays]="calendarDays()"
        [events]="filteredEvents()"
        [selectedDay]="selectedMonthlyDay()"
        [categories]="categories"
        (eventClick)="onEventClick($event)"
        (dayClick)="selectMonthlyDay($event)">
      </app-calendar-monthly>
    </div>

    <!-- SPIRAL DIVIDER -->
    <div class="spiral-divider"></div>

    <!-- RIGHT SIDE: DASHBOARD CARDS + EVENTS -->
    <div class="events-sidebar">
      <!-- DASHBOARD CARDS SECTION (Only show in weekly view) -->
      <div *ngIf="viewMode() === 'weekly'" class="dashboard-cards-section">
        <!-- INSPIRATION CARD -->
        <app-inspiration-card [currentDate]="selectedDate()"></app-inspiration-card>

        <!-- MUST GET DONE CARD -->
        <app-must-get-done-card 
          [highPriorityEvents]="weeklyHighPriorityEvents()"
          [categories]="categories">
        </app-must-get-done-card>

        <!-- WEEKLY HABITS CARD -->
        <app-weekly-habits-card [currentDate]="selectedDate()"></app-weekly-habits-card>
      </div>

      <!-- TOP PRIORITIES BOX (Daily view only) -->
      <mat-card class="priorities-box" *ngIf="viewMode() === 'daily'">
        <mat-card-header class="priorities-header">
          <h3>Top Priorities</h3>
        </mat-card-header>
        <mat-card-content class="priorities-content">
          <div *ngIf="topPriorities().length > 0; else noPriorities" class="priorities-list">
            <div *ngFor="let task of topPriorities()" class="priority-item">
              <div class="priority-indicator" [style.background-color]="getCategoryColor(task.category)"></div>
              <div class="priority-task-info">
                <div class="priority-title">{{ task.title }}</div>
                <div class="priority-time">{{ task.time }}</div>
              </div>
            </div>
          </div>
          <ng-template #noPriorities>
            <p class="no-priorities">No priority tasks for this day</p>
          </ng-template>
        </mat-card-content>
      </mat-card>

      <!-- EVENTS LIST HEADER WITH SHOW ALL MONTH BUTTON (Monthly view only) -->
      <div *ngIf="viewMode() === 'monthly' && monthlyViewMode() === 'day'" class="events-header-actions">
        <h3>{{ selectedMonthlyDay() | date:'EEEE, MMM d' }}</h3>
        <button mat-button (click)="showAllMonth()" class="show-all-btn">
          <mat-icon>calendar_month</mat-icon>
          Show all month
        </button>
      </div>

      <!-- EVENTS LIST FOR SELECTED PERIOD -->
      <app-events-list
        [events]="selectedPeriodEvents()"
        [viewMode]="viewMode()"
        [categories]="categories"
        (eventClick)="onEventClick($event)">
      </app-events-list>
    </div>
  </div>
</div>
