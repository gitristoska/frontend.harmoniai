<div class="daily-view-wrapper">
  <!-- LOADING STATE -->
  <div *ngIf="isLoading()" class="loading-state">
    <p>Loading daily entry...</p>
  </div>

  <!-- ERROR STATE -->
  <div *ngIf="error()" class="error-state">
    <p>{{ error() }}</p>
  </div>

  <!-- MAIN LAYOUT -->
  <div class="daily-view-layout" *ngIf="!isLoading()">
    
    <!-- GRID LAYOUT WITH NESTED DIVS -->
    <div class="daily-grid-layout">
      
      <!-- SECTION 1: Items 1,2,3 (Grateful For, Inspiration, Calendar) -->
      <div class="grid-section-top">
        
        <!-- Items 1,2: Grateful For & Inspiration (nested) -->
        <div class="grid-subsection-reflections">
          <!-- 1: Grateful For -->
          <mat-card class="notes-card grateful-for grid-item-1">
            <mat-card-header>
              <h3>Grateful For</h3>
            </mat-card-header>
            <mat-card-content>
              <textarea class="note-textarea" placeholder="What are you grateful for today?"
                [(ngModel)]="dailyEntry()!.gratefulFor"
                (blur)="saveDailyEntry()"></textarea>
            </mat-card-content>
          </mat-card>

          <!-- 2: Inspiration -->
          <mat-card class="notes-card inspiration grid-item-2">
            <mat-card-header>
              <h3>Inspiration</h3>
            </mat-card-header>
            <mat-card-content>
              <textarea class="note-textarea" placeholder="What inspired or motivated you today?"
                [(ngModel)]="dailyEntry()!.inspirationOrMotivation"
                (blur)="saveDailyEntry()"></textarea>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- 3: Daily Calendar -->
        <div class="calendar-main grid-item-3">
          <mat-card class="daily-view-card">
            <mat-card-header class="date-header">
              <h2>{{ selectedDate() | date:'EEEE, MMMM d, yyyy' }}</h2>
            </mat-card-header>

            <mat-card-content class="time-grid">
              <div *ngFor="let slot of getTimeSlots()" class="time-slot">
              <div class="time-label">{{ slot }}</div>
              <div class="events-container" 
                cdkDropList 
                cdkDropListGroup="calendar-drop-group"
                [cdkDropListData]="+slot.split(':')[0]"
                (cdkDropListDropped)="drop($event)">
                <div *ngFor="let event of getEventsByHour(+slot.split(':')[0])"
                  class="event-item"
                  [style.background-color]="getCategoryColor(event.category)"
                  (click)="onEventClick(event)"
                  cdkDrag
                  [cdkDragData]="event">
                  <span class="event-time">{{ event.time }}</span>
                  <span class="event-title">{{ event.title }}</span>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
      </div>
      
      <!-- SECTION 2: Items 4-9 (Priority, Tasks, Calls, Personal Notes, Rate Day, Notes Tomorrow) -->
      <div class="grid-section-middle">
        
        <!-- Items 4,5: Priority List & Tasks List (nested) -->
        <div class="grid-subsection-tasks">
          <!-- 4: Priority List (Tasks) -->
          <mat-card class="notes-card priority-list grid-item-4" style="
        max-height: 333px;
        overflow-y: auto;">
            <mat-card-header>
              <h3>Priority List</h3>
            </mat-card-header>
            <mat-card-content>
              <div class="note-items">
                <div *ngIf="topPriorities().length > 0; else noPriorities" class="priorities-list">
                  <div *ngFor="let task of topPriorities()" class="priority-item">
                    <div class="priority-indicator" [style.background-color]="getCategoryColor(task.category)"></div>
                    <div class="priority-task-info">
                      <div class="priority-title">{{ task.title }}</div>
                      <div class="priority-time">{{ task.time }}</div>
                    </div>
                  </div>
                </div>
                <ng-template #noPriorities>
                  <p class="no-priorities">No priority tasks for today</p>
                </ng-template>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- 5: Tasks List -->
          <mat-card class="notes-card tasks-list grid-item-5" style="min-height: 472px;
    max-height: 472px;
    overflow: auto;">
            <mat-card-header>
              <h3>Tasks List</h3>
            </mat-card-header>
            <mat-card-content>
              <div class="note-items">
                <div *ngIf="todayEvents().length > 0; else noTasks" class="tasks-list-items">
                  <div *ngFor="let task of todayEvents()" class="task-item">
                    <div class="task-indicator" [style.background-color]="getCategoryColor(task.category)"></div>
                    <div class="task-info" (click)="openEditTaskModal(task)" style="cursor: pointer; flex: 1;">
                      <div class="task-title">{{ task.title }}</div>
                      <div *ngIf="task.description" class="task-description">{{ task.description }}</div>
                      <div class="task-meta">
                        <span class="task-time">{{ task.time }}</span>
                        <span *ngIf="task.priority !== undefined && task.priority !== null" class="task-priority" [class]="'priority-' + getPriorityLabel(task.priority)">
                          {{ getPriorityLabel(task.priority) }}
                        </span>
                        <span class="task-status-label" [style.color]="getStatusInfo(task.status || 0).color">
                          {{ getStatusInfo(task.status || 0).label }}
                        </span>
                      </div>
                    </div>
                    <div class="task-status-section">
                      <button mat-icon-button [matMenuTriggerFor]="statusMenu" 
                        [style.color]="getStatusInfo(task.status || 0).color"
                        class="status-button"
                        title="Click to change status">
                        <mat-icon>{{ getStatusInfo(task.status || 0).icon }}</mat-icon>
                      </button>
                      <mat-menu #statusMenu="matMenu" class="status-menu">
                        <button *ngFor="let status of taskStatusOptions" 
                          mat-menu-item 
                          (click)="updateTaskStatus(task, status.value)"
                          [class.active]="task.status === status.value">
                          <mat-icon [style.color]="status.color" class="status-icon">{{ status.icon }}</mat-icon>
                          <span>{{ status.label }}</span>
                        </button>
                      </mat-menu>
                    </div>
                  </div>
                </div>
                <ng-template #noTasks>
                  <p class="no-tasks">No tasks for today</p>
                </ng-template>
              </div>
        </mat-card-content>
      </mat-card>
        </div>

        <!-- Items 6,7,8,9: Calls & Emails, Personal Notes, Rate Day, Notes Tomorrow (nested) -->
        <div class="grid-subsection-tracking">
          <!-- 6: Calls and Email -->
          <mat-card class="notes-card calls-emails grid-item-6">
        <mat-card-header>
          <h3>Calls & Emails</h3>
        </mat-card-header>
        <mat-card-content>
          <div class="note-items">
            <div *ngFor="let item of dailyEntry()?.callsAndEmailsChecklist || []" class="note-item">
              <mat-checkbox 
                [checked]="item.isDone"
                (change)="toggleNoteItem(item)">
                <span [class.completed]="item.isDone">{{ item.text }}</span>
              </mat-checkbox>
              <div class="item-actions">
                <button mat-icon-button (click)="editCallsEmailItem(item)" title="Edit">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button (click)="deleteCallsEmailItem(item)" title="Delete">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
            <input #callsEmailsInput type="text" class="add-item-input" placeholder="Add item..."
              (keyup.enter)="addAndClearNoteItem('callsEmails', callsEmailsInput)" />
          </div>
        </mat-card-content>
      </mat-card>

      <!-- 7: Personal Notes -->
      <mat-card class="notes-card personal-notes grid-item-7">
        <mat-card-header>
          <h3>Personal Notes</h3>
        </mat-card-header>
        <mat-card-content>
          <textarea class="note-textarea" placeholder="Write your personal notes..."
            [(ngModel)]="dailyEntry()!.personalNotes"
            (blur)="saveDailyEntry()"></textarea>
        </mat-card-content>
      </mat-card>

      <!-- 8: Rate Your Day -->
      <mat-card class="rate-day-card grid-item-8" style="overflow: unset;">
            <mat-card-header>
              <h3>Rate Your Day</h3>
            </mat-card-header>
            <mat-card-content>
              <div class="rating-section">
                <label>Productivity</label>
                <div class="rating-stars">
                  <span *ngFor="let i of [1,2,3,4,5]"
                    class="star"
                    [class.filled]="(dayRating().productivity || 1) >= i"
                    (click)="setProductivityRating(i)">
                    ‚òÖ
                  </span>
                </div>
              </div>

              <div class="rating-section">
                <label>Mood</label>
                <div class="rating-moods">
                  <span *ngFor="let i of [1,2,3,4,5]"
                    class="mood"
                    [class.filled]="(dayRating().mood || 1) >= i"
                    (click)="setMoodRating(i)">
                    üòä
                  </span>
                </div>
              </div>

              <div class="rating-section">
                <label>Health</label>
                <div class="rating-hearts">
                  <span *ngFor="let i of [1,2,3,4,5]"
                    class="heart"
                    [class.filled]="(dayRating().health || 1) >= i"
                    (click)="setHealthRating(i)">
                    ‚ù§Ô∏è
                  </span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- 9: Notes for Tomorrow -->
          <mat-card class="notes-card notes-tomorrow grid-item-9">
            <mat-card-header>
              <h3>Notes for Tomorrow</h3>
            </mat-card-header>
            <mat-card-content>
              <textarea class="note-textarea" placeholder="Write notes for tomorrow..."
                [(ngModel)]="dailyEntry()!.notesForTomorrow"
                (blur)="saveDailyEntry()"></textarea>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <!-- SECTION 3: Items 10,11 (Life Balance & AI Recommendations) -->
      <div class="grid-section-bottom">
        <!-- 10: Life Balance List -->
        <mat-card class="notes-card life-balance grid-item-10">
          <mat-card-header>
            <h3>Life Balance To-Do List</h3>
          </mat-card-header>
          <mat-card-content>
            <div class="life-balance-table">
              <div class="life-balance-category" *ngFor="let category of groupLifeBalanceByCategory() | keyvalue">
                <div class="category-header">{{ category.key }}</div>
                <div class="note-items">
                  <div *ngFor="let item of category.value" class="note-item">
                    <mat-checkbox 
                      [checked]="item.isDone"
                      (change)="toggleNoteItem(item)">
                      <span [class.completed]="item.isDone">{{ item.text }}</span>
                    </mat-checkbox>
                    <div class="item-actions">
                      <button mat-icon-button (click)="editLifeBalanceItem(item)" title="Edit">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button mat-icon-button (click)="deleteLifeBalanceItem(item)" title="Delete">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                  <input #categoryInput type="text" class="add-item-input" placeholder="Add..." 
                    (keyup.enter)="addAndClearNoteItem('lifeBalance', categoryInput, getCategoryKey(category.key))" />
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- 11: AI Recommendations -->
        <mat-card class="ai-recommendations-card grid-item-11">
          <mat-card-header>
            <mat-icon class="ai-icon">sparkles</mat-icon>
            <h3>AI Recommendations</h3>
          </mat-card-header>
          <mat-card-content>
            <div *ngFor="let rec of aiRecommendations()" class="recommendation-item">
              <p class="recommendation-text">{{ rec.text }}</p>
            <div class="recommendation-actions">
              <button class="add-btn" (click)="toggleRecommendation(rec)">
                <mat-icon>{{ rec.added ? 'check' : 'add' }}</mat-icon>
                {{ rec.added ? 'Added' : 'Add' }}
              </button>
              <button class="remove-btn" (click)="removeRecommendation(rec.id)">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
      </div>

    </div>
  </div>
</div>
